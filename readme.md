# llmcpp

## 概要
llmcpp は、oobabooga/text-generation-webui(https://github.com/oobabooga/text-generation-webui) により提供される Open-API 互換の Web API を利用して、ローカル環境でテキスト生成する作業を支援する CLI のフロントエンドである。

## 機能
* 小説の執筆のように、過去に生成されたテキストが蓄積し肥大化する作業において、有限で貧弱なコンテキストに収まるようプロンプトを構成する要素の比率を調整する。
* テキストを生成する工程を自然言語による記述で構造化する。(`{{phase}}` マクロ)
* プロンプトや生成されたテキストを任意の複数のファイルに分割して管理する。(`{{include:<filename>}}` マクロや、マクロに対応したコマンドラインオプション)
* LLM のトークナイザーが通信により返したトークン数の情報をローカルにキャッシュし高速に再利用する。
* スタックトレースを含むデバッグに有益な情報を、重要度に応じてフィルタリング可能な形態でログ出力する。
* 主に Windows 環境のように UTF-8 をターミナルの標準のコードページとして採用していない OS 環境に対して、文字コードを UTF-8 に統一して扱う。

## ビルド要求
* Boost 1.88.0+
	* https://www.boost.org/
* C++20+

## 事前準備
1. `text-generation-webui/user_data/CMD_FLAGS.txt` にて ` --api` オプションを指定する。
2. `start_windows.bat` など実行環境と対応するスクリプトを実行し、サーバーを起動する。

## チュートリアル
llmcpp はデフォルトで下記のファイルを読み込む。

| ファイル名 | 概要 | 変更するオプション |
| --- | --- | --- |
| system_prompts.txt | システムプロンプト | --system-prompts-file |
| examples.txt | 生成したいテキストの例 | --examples-file |
| history.txt | 直近に生成されたテキスト | --history-file |

ログはデフォルトで下記に出力される。

* log.txt

ログをコンソールに冗長に出力する場合、`-v` オプションを指定する。

```
> llmcpp -v
```

ログに出力する情報を範囲を変更する場合、 `--log-level` オプションに続き、`(trace|debug|info|warning|error|fatal)` のいずれか指定する。デフォルトでは `info` が使用される。

必要に応じて下記のオプションで通信先を指定する。oobabooga をデフォルトの設定で運用している場合、明示的に指定する必要はない。

* `--host`
* `--port`
* `--api-key`

実行を開始すると、 llmcpp は下記のように LLM に渡すプロンプトを作成する。

1. `system_prompts.txt` の内容をプロンプトに追加する。
2. `history.txt` の内容を、末尾の行から優先して可能な限り、本来の順序でプロンプトに追加する。
3. `examples.txt` の内容を、可能な限り、本来の順序でプロンプトに追加する。
4. `--generation-prefix` オプションで指定された文字列をプロンプトに追加する。

LLM に渡すプロンプトは、
ここでいう可能な限りとは、「`--max-total-context-tokens` オプションで指定しているコンテキストの最大トークン数(デフォルトの値は `4096`)から、`--max-tokens` オプションで指定している LLM により生成されるテキストの最大トークン数(デフォルトの値は `512`)を差し引いたトークン数を超過しない限り」を意味する。
つまり llmcpp は、「プロンプト」と「LLM により生成されるテキスト」を足した全体のトークン数が、コンテキストの最大トークン数以下に収まるよう、`history.txt` や `examples.txt` から読み込むテキストの量を調整する。

プロンプトを作成した後、LLM と通信し、テキストを生成する。
生成されたテキストの先頭には `--generation-prefix` オプションで指定された文字列が含まれる。
デフォルトでは、生成したテキストは `history.txt` の末尾に追加される。変更する場合は `--output-file` で出力先を指定する。親フォルダが存在しない場合、自動的に作成される。

繰り返しテキストを生成すると、`history.txt` の内容は増加し、いつかその全量がコンテキストの最大トークン数に収まらなくなる。
前述の戦略により、`history.txt` の内容は増加した後においても、可能な限り最新の生成されたテキストをプロンプトに含める。

LLMに小説を生成させる場合、`history.txt` は作成された文章になる。
LLMとチャットをする場合、`history.txt` は会話の履歴になる。

## 反復
`-N` オプションにより処理を反復する回数を指定することができる。デフォルトの値は `1` である。`-1` を指定すると実行を停止するまで無限に処理を反復する。


## マクロ
囲まれたマクロを以下の文脈で使用することができる。

* 各種テキストファイルの内容
* コマンドラインオプションで指定するファイルパス

マクロは特定の文字列を `{{` と `}}` で囲むことにより記述する。
マクロは実行時の反復毎、pahse の実行毎に展開される。
ただし、`--log-file` で指定されたログファイルのパスは、プログラムの開始時に一度だけマクロを展開され、以降その時点のパスを使用し続ける。
これはプログラムがログファイルのストリームを開いたまま保持し効率的にログ出力するための制限である。

マクロは `--define` オプションにより事前に定義することができる。
`--define "user={{user}}" "char={{char}}"` というようにマクロの展開先にマクロを指定することができる。
ただし上記のようにマクロの展開後の文字列が展開前の文字列と完全に一致した場合、再帰的なマクロの展開は中断される。
このような冗長なマクロの定義は、マクロを含むプロンプトを LLM を使用して生成する際に、マクロの展開を抑止するために役立つ。

### `{{phase}}`
1回の処理は1個以上の phase から構成され、それらは順番に実行される。
phase は `--phases "MyPhase1" "MyPhase2" "MyPhase3"` オプションで任意の数だけ指定可能である。 
現在実行中の phase は、プロンプトの内容に `{{phase}}` マクロを記述することにより、実行時に参照できる。
前の phase は `{{prev_phase}}` マクロ、次の phase は `{{next_phase}}` マクロで参照できる。

`--mode novel` オプションを指定することは、`--phases "" --generation-prefix ""`オプションを指定することと等価である。
`--mode chat` オプションを指定することは、`--phases "{{char}}" "{{user}}" --generation-prefix "{{phase}}}: "`オプションを指定することと等価である。
`--mode` オプションを指定しない場合、デフォルトで `--mode novel` が使用される。

すなわち、 `chat` モードでは、pahse として現在発言している人物の名前を扱い、それをプロンプトの先頭に追加することにより、LLM が当該の人物の発言を生成するように誘導する。
`system_prompts.txt` の内容に phase の要素に関する説明を含めることにより、1回の処理を複数の工程に分割し、動的に生成の方法を制御することができる。

`--mode novel` オプションを指定し、かつ `--plot-file` オプションでプロットファイルを指定した場合、プロットファイルに含まれる内容が phase に割り当てられる。
プロットファイルは、順序リストあるいは非順序リストにより段落の名前を記述し、その直後にインデントされた順序リストあるいは非順序リストによりその段落の説明を記述した、マークダウン記法に準拠したファイルである。下記はプロットファイルの具体例である。

```
1. 段落1の名前
    * 説明1
    * 説明2
    * 説明3
2. 段落2の名前
    * 説明1
    * 説明2
    * 説明3
3. 段落3の名前
    * 説明1
    * 説明2
    * 説明3
```

具体的な利用例として、`system_prompts.txt` に下記のように記述すれば、現在の段落と前後の段落に関する情報をプロンプトに含めることができる。

```
# 段落の情報
## 現在の段落
{{phase}}

## 前の段落
{{prev_phase}}

## 次の段落
{{next_phase}}
```

これにより、LLM が物語として一貫し、秩序正しいテキストを生成するよう誘導することができる。

### `{{include:<filename>}}`
`:` の右側で指定されたテキストファイルの内容に展開される。ファイル名は拡張子を省略して記述し、実行時に `.txt` を補完して解釈される。
これによりプロンプトを複数のファイルに分割して管理することができる。

### `{{datetime}}`
`yyyyMMddhhmmss` 形式で表現された実行時点の時刻に展開される。主に生成したテキストを生成単位で出力する目的で使用する。

### `{{N}}`
1から開始する現在の反復回数に展開される。主に生成したテキストを反復単位で出力する目的で使用する。